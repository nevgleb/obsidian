Когда приложение уязвимо для внедрения SQL и результаты запроса возвращаются в ответах приложения, вы можете использовать ключевое слово `UNION` для извлечения данных из других таблиц в базе данных. Это обычно известно как атака с объединением SQL-инъекций.

Ключевое слово `UNION` позволяет выполнить один или несколько дополнительных `SELECT` запросов и добавить результаты к исходному запросу. Например:

`SELECT a, b FROM table1 UNION SELECT c, d FROM table2`

Этот SQL-запрос возвращает единый результирующий набор с двумя столбцами, содержащий значения из столбцов `a` и `b` в `table1` и столбцах `c` и `d` в `table2`.

## Условия нобходимы для эксплуатации
Для работы `UNION` запроса необходимо выполнить два ключевых требования:

- Отдельные запросы должны возвращать одинаковое количество столбцов.
- Типы данных в каждом столбце должны быть совместимы между отдельными запросами.

Чтобы выполнить атаку с объединением SQL-инъекций, убедитесь, что ваша атака соответствует этим двум требованиям. Обычно для этого требуется выяснить:

- Сколько столбцов возвращается из исходного запроса.
- Какие столбцы, возвращаемые из исходного запроса, имеют подходящий тип данных для хранения результатов введенного запроса.

## Определение требуемого количества столбцов

Два  метода определения количества столбцов, возвращаемых из исходного запроса:
- внедрение серии `ORDER BY` предложений и увеличение указанного индекса столбца до тех пор, пока не возникнет ошибка.
-  отправку серии `UNION SELECT` полезных нагрузок с указанием различного количества нулевых значений:


### Пример внедрения серии `ORDER BY`
Например, если точкой внедрения является строка, заключенная в кавычки, в `WHERE` предложении исходного запроса, вы должны отправить:

```
' ORDER BY 1-- 
' ORDER BY 2-- 
' ORDER BY 3-- 
etc.
```


> [!NOTE] Замечение
> Столбец в предложении `ORDER BY` может быть указан по его индексу, поэтому вам не нужно знать названия каких-либо столбцов.

Когда указанный индекс столбца превышает количество фактических столбцов в результирующем наборе, база данных возвращает ошибку, такую как:

` The ORDER BY position number 3 is out of range of the number of items in the select list.`

Приложение может в HTTP ответе вернуть ошибку бд, а может просто общую ошибку, или вообще ничего. ==Пока можно увидеть разницу в запросах, то можно отследить ошибку==
### Пример внедрения серии `UNION SELECT`
Мы используем `NULL` в качестве значений, возвращаемых из введенного `SELECT` запроса, потому что типы данных в каждом столбце должны быть совместимы между исходным и введенным запросами. `NULL` преобразуется во все распространенные типы данных, поэтому он максимизирует вероятность успешного выполнения полезной нагрузки при правильном подсчете столбцов.

```
' UNION SELECT NULL-- 
' UNION SELECT NULL,NULL-- 
' UNION SELECT NULL,NULL,NULL-- 
etc.
```

Когда количество значений null совпадает с количеством столбцов, база данных возвращает дополнительную строку в результирующем наборе, содержащую значения null в каждом столбце.

Влияние на HTTP-ответ зависит от кода приложения. Если вам повезет, вы увидите некоторое дополнительное содержимое в ответе, например, дополнительную строку в HTML-таблице. В противном случае значения null могут вызвать другую ошибку, такую как `NullPointerException`. В худшем случае ответ может выглядеть так же, как ответ, вызванный неправильным количеством нулей. Это сделало бы этот метод неэффективным.

## Синтаксис, зависящий от базы данных

В Oracle каждый `SELECT` запрос должен использовать `FROM` ключевое слово и указывать допустимую таблицу. В Oracle есть встроенная таблица под названием `dual`, которую можно использовать для этой цели. Таким образом, введенные запросы в Oracle должны выглядеть следующим образом:

`' UNION SELECT NULL FROM DUAL--`

В описанных полезных нагрузках используется последовательность комментариев с двойным тире `--` для закомментирования оставшейся части исходного запроса после точки внедрения. В MySQL после последовательности с двойным тире должен быть пробел. В качестве альтернативы, символ хэша `#` может использоваться для идентификации комментария.

Для получения более подробной информации о синтаксисе, специфичном для базы данных, см. [Шпаргалку по SQL-инъекции](https://portswigger.net/web-security/sql-injection/cheat-sheet).

## Поиск столбцов с полезным типом данных

Атака с объединением SQL-инъекций позволяет получить результаты из введенного запроса. Интересные данные, которые вы хотите получить, ==обычно представлены в виде строки==. Это означает, что вам нужно найти один или несколько столбцов в исходных результатах запроса, тип данных которых соответствует строковым данным или совместим с ними.

После определения количества требуемых столбцов вы можете исследовать каждый столбец, чтобы проверить, может ли он содержать строковые данные. Вы можете отправить серию `UNION SELECT` полезных нагрузок, которые поочередно помещают строковое значение в каждый столбец. Например, если запрос возвращает четыре столбца, вы должны отправить:

```
' UNION SELECT 'a',NULL,NULL,NULL-- 
' UNION SELECT NULL,'a',NULL,NULL-- 
' UNION SELECT NULL,NULL,'a',NULL-- 
' UNION SELECT NULL,NULL,NULL,'a'--
```

Если тип данных столбца несовместим со строковыми данными, введенный запрос вызовет ошибку базы данных, например:

`Conversion failed when converting the varchar value 'a' to data type int.`

> [!NOTE] Заметка
>  Если ошибка не возникает, а ответ приложения содержит некоторое дополнительное содержимое, включая введенное строковое значение, то соответствующий столбец подходит для извлечения строковых данных.


## Использование атаки объединения SQL-инъекций для извлечения интересных данных

Когда вы определили количество столбцов, возвращаемых исходным запросом, и нашли, какие столбцы могут содержать строковые данные, вы можете получить интересные данные.

Предположим, что:

- Исходный запрос возвращает два столбца, оба из которых могут содержать строковые данные.
- Точка внедрения - это строка, заключенная в кавычки внутри `WHERE` предложения.
- База данных содержит таблицу с именем `users` со столбцами `username` и `password`.

В этом примере вы можете получить содержимое `users` таблицы, отправив входные данные:

`' UNION SELECT username, password FROM users--`

Чтобы выполнить эту атаку, вам нужно знать, что существует таблица с именем `users` с двумя столбцами, которые называются `username` и `password`. Без этой информации вам пришлось бы угадывать названия таблиц и столбцов. Все современные базы данных предоставляют способы изучения структуры базы данных и определения того, какие таблицы и столбцы они содержат.

## Извлечение нескольких значений в одном столбце

В некоторых случаях запрос  может возвращать только один столбец.

Вы можете получить несколько значений вместе в этом единственном столбце, объединив значения вместе. Вы можете включить разделитель, позволяющий различать объединенные значения. Например, в Oracle вы могли бы отправлять входные данные:

`' UNION SELECT username || '~' || password FROM users--`

Разные базы данных используют разный синтаксис для выполнения конкатенации строк. Более подробную информацию смотрите в [шпаргалке по SQL-инъекции](https://portswigger.net/web-security/sql-injection/cheat-sheet).